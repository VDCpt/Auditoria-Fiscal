<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Auditoria Fiscal TVDE (VDC)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 25px; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }
        h1, h2 { text-align: center; color: #333; }
        #filenameTitle { display: block; text-align: center; font-size: 1.1em; font-weight: bold; color: #007bff; margin-bottom: 25px; padding: 10px; border: 1px dashed #007bff; background-color: #e6f7ff; border-radius: 4px; }
        .header-info, .auth-info, .company-info { display: flex; justify-content: space-around; margin-bottom: 20px; font-weight: bold; gap: 20px; }
        .columns-container { display: flex; justify-content: space-between; gap: 30px; margin-top: 30px; }
        .column { flex: 0 0 48%; padding: 20px; border: 1px solid #ddd; border-radius: 6px; background-color: #ffffff; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .input-group input, .input-group select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .result-group { padding: 15px; border-top: 1px solid #ccc; margin-top: 15px; background-color: #f9f9f9; border-radius: 4px; }
        .result-group strong { font-weight: bold; display: block; margin-top: 5px; font-size: 1.1em; }
        .auditoria-section { margin-top: 40px; padding: 25px; border: 2px solid #a33; background-color: #ffeaea; border-radius: 8px; }
        .discrepancy { font-size: 1.4em; font-weight: bold; color: #d9534f; margin: 15px 0; padding: 15px; border: 1px dashed #d9534f; background-color: #fdd; text-align: center; border-radius: 4px; }
        .button-container { display: flex; justify-content: space-between; gap: 15px; margin-top: 30px; }
        .action-button { flex: 1; padding: 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .action-button.calculate { background-color: #28a745; }
        
        /* Estilos de Impressão */
        @media print {
            .button-container, input, select { display: none !important; }
            span.print-only { display: block !important; border-bottom: 1px solid #eee; padding: 5px 0; }
            .container { box-shadow: none; max-width: 100%; }
            .columns-container { display: block; }
            .column { width: 100%; margin-bottom: 20px; page-break-inside: avoid; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Relatório de Auditoria Fiscal TVDE (VDC)</h1>
        <div id="filenameTitle">NOME DO FICHEIRO: AAAA_MM_PLATAFORMA_ID_ANALISE.pdf</div>
        
        <div class="company-info">
            <div class="input-group">
                <label>Plataforma:</label>
                <select id="nomeEmpresa">
                    <option value="Uber">Uber</option>
                    <option value="Bolt">Bolt</option>
                </select>
                <span id="nomeEmpresaPrint" class="print-only"></span>
            </div>
            <div class="input-group">
                <label>NIPC Sede Estrangeira:</label>
                <input type="text" id="nifEmpresa" placeholder="505505858">
                <span id="nifEmpresaPrint" class="print-only"></span>
            </div>
        </div>

        <div class="header-info">
            <div class="input-group">
                <label>ID Amostra:</label>
                <input type="text" id="idProcesso">
                <span id="idProcessoPrint" class="print-only"></span>
            </div>
            <div class="input-group">
                <label>Mês/Ano:</label>
                <input type="text" id="mes" placeholder="JAN" style="width: 45%; display:inline;">
                <input type="text" id="ano" placeholder="2025" style="width: 45%; display:inline;">
            </div>
        </div>

        <div class="columns-container">
            <div class="column">
                <h3>4. Ganhos na APP (Operacional)</h3>
                <div class="input-group">
                    <label>Comissão Retida (€):</label>
                    <input type="text" id="comissaoPlataformaOperacionais" inputmode="decimal" value="489.01">
                </div>
                <div class="input-group">
                    <label>Taxas de Reserva (€):</label>
                    <input type="text" id="taxasReservaDeducoes" inputmode="decimal" value="1.00">
                </div>
                <div class="input-group" style="background-color: #e6f7ff; padding: 10px;">
                    <label>Ganhos Líquidos (APP) (€):</label>
                    <input type="text" id="ganhosLiquidosInput" inputmode="decimal" value="968.02">
                </div>
                <div class="result-group">
                    <label>BTOR (Base Retida):</label>
                    <strong id="btOperacionalResultado">0.00 €</strong>
                </div>
            </div>

            <div class="column">
                <h3>5. Fatura Emitida (Fiscal)</h3>
                <div class="input-group">
                    <label>Valor Faturado (BTF) (€):</label>
                    <input type="text" id="baseTributavelFaturada" inputmode="decimal" value="0.00">
                </div>
                <div class="result-group" style="background-color: #fffbe6;">
                    <label>BTF (Base Faturada):</label>
                    <strong id="btFaturadaResultado">0.00 €</strong>
                </div>
            </div>
        </div>

        <div class="auditoria-section">
            <h2>6. Resultado da Auditoria e Discrepância</h2>
            <div class="input-group">
                <label>Motoristas Ativos (Média Mercado):</label>
                <input type="text" id="motoristasAtivos" value="38638">
            </div>

            <div class="discrepancy">
                <small>DISCREPÂNCIA TOTAL:</small><br>
                <span id="discrepanciaResultado">0.00 €</span>
            </div>

            <div class="result-group">
                <label>Omissão IVA Potencial (6%):</label>
                <strong id="ivaPotencialResultado">0.00 €</strong>
            </div>

            <p>Potencial Mensal Mercado: <strong id="valorOmitidoMensal">0.00 €</strong></p>
            <p>Potencial Anual Mercado: <strong id="valorOmitidoAnual">0.00 €</strong></p>
        </div>

        <div class="button-container">
            <button class="action-button calculate" onclick="executarAuditoria()">Calcular / Atualizar</button>
            <button class="action-button" onclick="window.print()">Gerar Relatório PDF</button>
        </div>
    </div>

    <script>
        function parseValue(id) {
            let val = document.getElementById(id).value;
            if (!val) return 0;
            return parseFloat(val.replace(',', '.')) || 0;
        }

        function formatEuro(val) {
            return val.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' });
        }

        function executarAuditoria() {
            // Dados de Entrada
            const comissao = parseValue('comissaoPlataformaOperacionais');
            const taxas = parseValue('taxasReservaDeducoes');
            const btf = parseValue('baseTributavelFaturada');
            const motoristas = parseValue('motoristasAtivos');

            // Cálculos
            const btor = comissao + taxas;
            const discrepancia = btor - btf;
            const iva = discrepancia * 0.06;
            const mensal = discrepancia * motoristas;
            const anual = mensal * 12;

            // Atualizar UI
            document.getElementById('btOperacionalResultado').innerText = formatEuro(btor);
            document.getElementById('btFaturadaResultado').innerText = formatEuro(btf);
            document.getElementById('discrepanciaResultado').innerText = formatEuro(discrepancia);
            document.getElementById('ivaPotencialResultado').innerText = formatEuro(iva);
            document.getElementById('valorOmitidoMensal').innerText = formatEuro(mensal);
            document.getElementById('valorOmitidoAnual').innerText = formatEuro(anual);

            // Espelhamento para Impressão
            const ids = ['nomeEmpresa', 'nifEmpresa', 'idProcesso'];
            ids.forEach(id => {
                document.getElementById(id + 'Print').innerText = document.getElementById(id).value;
            });

            // Nome do Ficheiro Dinâmico
            const fName = `${document.getElementById('ano').value || '2025'}_${document.getElementById('mes').value || 'JAN'}_${document.getElementById('nomeEmpresa').value}_${document.getElementById('idProcesso').value}.pdf`;
            document.getElementById('filenameTitle').innerText = "NOME DO FICHEIRO: " + fName.toUpperCase();
        }

        // Executar ao carregar e ao digitar
        window.onload = executarAuditoria;
        document.querySelectorAll('input').forEach(i => i.addEventListener('input', executarAuditoria));
    </script>
</body>
</html>
